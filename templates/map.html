{% extends "layout.html" %}

{% block title %}
map
{% endblock %}

{% block top %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map {
        height: 500px;
        width: 70%;
        margin: 0 auto;
    }
</style>
<div id="map"></div>
<p>盛岡駅との距離</p>
<list id="distance">


</list>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // 現在位置を取得する関数
    async function getMyPosition() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        console.log("Latitude: " + position.coords.latitude);
                        console.log("Longitude: " + position.coords.longitude);
                        resolve([position.coords.latitude, position.coords.longitude]);
                    },
                    function (error) {
                        console.log("Error: " + error.message);
                        reject(error);
                    }
                );
            } else {
                console.log("Geolocation is not supported by this browser.");
                resolve([0, 0]);
            }
        });
    }
    // 関数を呼び出す
    getMyPosition().then((position) => {
        console.log(position);
        const myPosition = position;
        myLatitude = myPosition[0];
        myLongitude = myPosition[1];
        moriokaLatitude = 39.70196447156899;
        moriokaLongitude = 141.13575319162757;
        var distances = []
        {% for shelter in shelters %}
        distance = Math.sqrt(({{shelter.Latitude}} - moriokaLatitude) ** 2 + ({{shelter.Longitude}} - moriokaLongitude) ** 2);
        console.log(distance);
        distances.push(distances.innerHTML = distance.toFixed(2) + "km")
        {% endfor %}

        var list = document.createElement("list");
        list.textContent = distances;
        //document内のbody要素の中にpタグを挿入する
        document.body.appendChild(list);


        // 地図の初期表示
        var map = L.map('map').setView([myPosition[0], myPosition[1]], 13);

        // 地図タイルの設定
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 避難所のマーカーを追加
        {% for shelter in shelters %}
        var marker = L.marker([{{ shelter.Latitude }}, {{ shelter.Longitude }}]).addTo(map)
            .bindPopup('{{ shelter.name }}')
            .openPopup();
        marker.setIcon(L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }));
        {% endfor %}
        {% for hospital in hospitals %}
        var marker = L.marker([{{ hospital.Latitude }}, {{ hospital.Longitude }}]).addTo(map)
            .bindPopup('{{ hospital.name }}')
            .openPopup();
        marker.setIcon(L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }));
        {% endfor %}
        {% for pharmacy in pharmacies %}
        var marker = L.marker([{{ pharmacy.Latitude }}, {{ pharmacy.Longitude }}]).addTo(map)
            .bindPopup('{{ pharmacy.name }}')
            .openPopup();
        marker.setIcon(L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }));
        {% endfor %}

    });

    
</script>



{% endblock %}